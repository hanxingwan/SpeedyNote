name: Build SpeedyNote Packages

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  release:
    types: [ created ]

# Prevent duplicate builds on PR pushes
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU for multi-architecture
        if: matrix.arch != 'x86_64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch == 'arm64' && 'arm64' || 'amd64' }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            make \
            pkg-config \
            qt6-base-dev \
            qt6-tools-dev \
            libpoppler-qt6-dev \
            libsdl2-dev \
            libasound2-dev \
            dpkg-dev \
            devscripts \
            qemu-user-static

      - name: Create DEB package
        run: |
          # 设置架构环境变量
          export BUILD_ARCH=${{ matrix.arch }}
          ./build-package.sh --deb

      - name: Upload DEB package
        uses: actions/upload-artifact@v4
        with:
          name: speedynote-deb-package-${{ matrix.arch }}
          path: "*.deb"

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]
        include:
          - arch: x86_64
            container_image: fedora:latest
          - arch: aarch64
            container_image: fedora:latest
    container:
      image: ${{ matrix.container_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            cmake \
            make \
            pkgconf \
            qt6-qtbase-devel \
            qt6-qttools-devel \
            poppler-qt6-devel \
            SDL2-devel \
            alsa-lib-devel \
            rpm-build \
            qemu-user-static

      - name: Create RPM package
        run: |
          # 设置架构环境变量
          export BUILD_ARCH=${{ matrix.arch }}
          ./build-package.sh --rpm

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: speedynote-rpm-package-${{ matrix.arch }}
          path: "*.rpm"

  build-exe:
    name: Build Windows EXE
    runs-on: windows-latest
    if: github.event_name != 'push'
    strategy:
      matrix:
<<<<<<< HEAD
=======
        # arch: [x86_64]
        # Temporarily disabled ARM64 build until toolchain is stable
>>>>>>> parent of d0e675d (Merge pull request #100 from alpha-liu-01/test)
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            msys_prefix: mingw-w64-clang-x86_64
            msystem: CLANG64
            build_args: ""
          - arch: arm64
            msys_prefix: mingw-w64-clang-aarch64
            msystem: CLANGARM64
            build_args: "-arm64"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: >
            ${{ matrix.msys_prefix }}-clang
            ${{ matrix.msys_prefix }}-lld
            ${{ matrix.msys_prefix }}-make
            ${{ matrix.msys_prefix }}-cmake
            ${{ matrix.msys_prefix }}-pkgconf
            ${{ matrix.msys_prefix }}-qt6-base
            ${{ matrix.msys_prefix }}-qt6-tools
            ${{ matrix.msys_prefix }}-qt6-translations
            ${{ matrix.msys_prefix }}-poppler
            ${{ matrix.msys_prefix }}-poppler-qt6
            ${{ matrix.msys_prefix }}-SDL2

      - name: Build
        shell: msys2 {0}
        timeout-minutes: 45
        run: |
          # Set up environment for the build
          export MSYSTEM=${{ matrix.msystem }}
          export PATH="/${{ matrix.msystem }}/bin:$PATH"
          
<<<<<<< HEAD
          # MSYS2 directories are lowercase, but MSYSTEM env var is uppercase
          $msysDir = "${{ matrix.msystem }}".ToLower()
          Write-Host "Using MSYS2 environment: ${{ matrix.msystem }} (path: $msysDir)" -ForegroundColor Cyan
          
          Write-Host "::group::Prepare build directory" -ForegroundColor Cyan
          if (Test-Path "build") { Remove-Item -Path "build" -Recurse -Force }
          New-Item -ItemType Directory -Path "build" | Out-Null
          
          # Compile translations
          $lreleaseExe = "D:\a\_temp\msys64\$msysDir\bin\lrelease-qt6.exe"
          if (Test-Path $lreleaseExe) {
            Write-Host "Compiling translation files..." -ForegroundColor Green
            & $lreleaseExe ./resources/translations/app_zh.ts ./resources/translations/app_fr.ts ./resources/translations/app_es.ts
            Copy-Item -Path ".\resources\translations\*.qm" -Destination ".\build" -Force -ErrorAction SilentlyContinue
          } else {
            Write-Host "Warning: lrelease not found at $lreleaseExe, skipping translations" -ForegroundColor Yellow
          }
          Write-Host "::endgroup::"
=======
          echo "::group::Prepare build directory"
          # Create build directory
          rm -rf build
          mkdir -p build
          
          # Compile translations if lrelease exists
          if command -v lrelease-qt6 &> /dev/null; then
            echo "Compiling translation files..."
            lrelease-qt6 ./resources/translations/app_zh.ts ./resources/translations/app_fr.ts ./resources/translations/app_es.ts
            cp ./resources/translations/*.qm ./build/ 2>/dev/null || true
          else
            echo "Warning: lrelease-qt6 not found, skipping translations"
          fi
          echo "::endgroup::"
>>>>>>> parent of d0e675d (Merge pull request #100 from alpha-liu-01/test)
          
          cd build
          
<<<<<<< HEAD
          # Setup environment - add MSYS2 to PATH
          $env:PATH = "D:\a\_temp\msys64\$msysDir\bin;$env:PATH"
=======
          echo "::group::Configure CMake"
          # Configure CMake
          cmake -G "MinGW Makefiles" \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_MAKE_PROGRAM=mingw32-make \
            -DCMAKE_BUILD_TYPE=Release \
            ${{ matrix.arch == 'arm64' && '-DCMAKE_SYSTEM_PROCESSOR=arm64' || '-DCPU_ARCH=modern' }} \
            ..
          echo "::endgroup::"
>>>>>>> parent of d0e675d (Merge pull request #100 from alpha-liu-01/test)
          
          echo "::group::Build project"
          # Build with reduced parallelism to avoid memory issues
          # GitHub Actions runners have limited memory, so use -j2 instead of all cores
          cmake --build . --config Release -- -j2
          echo "::endgroup::"
          
<<<<<<< HEAD
          if ("${{ matrix.arch }}" -eq "arm64") {
            $cmakeArgs += "-DCMAKE_SYSTEM_PROCESSOR=arm64"
          } else {
            $cmakeArgs += "-DCPU_ARCH=modern"
          }
          
          & cmake @cmakeArgs ..
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          Write-Host "::endgroup::"
          
          Write-Host "::group::Build project" -ForegroundColor Cyan
          Write-Host "Building with single-threaded compilation to avoid memory issues..." -ForegroundColor Yellow
          & cmake --build . --config Release -- -j16
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          Write-Host "::endgroup::"
          
          Write-Host "::group::Deploy Qt runtime" -ForegroundColor Cyan
          & windeployqt6 NoteApp.exe
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          Write-Host "::endgroup::"
          
          Write-Host "::group::Copy dependencies" -ForegroundColor Cyan
          $sourceDir = "D:\a\_temp\msys64\$msysDir\bin"
=======
          echo "::group::Deploy Qt runtime"
          # Deploy Qt runtime
          windeployqt6 NoteApp.exe
          echo "::endgroup::"
>>>>>>> parent of d0e675d (Merge pull request #100 from alpha-liu-01/test)
          
          echo "::group::Copy dependencies"
          # Copy required DLLs
          echo "Copying required DLLs..."
          for dll in libpoppler-*.dll libdeflate.dll libiconv-2.dll libnettle-8.dll Qt6Core.dll libexpat-1.dll libicuin*.dll libicuuc*.dll libfreetype-6.dll libfontconfig-1.dll libglib-2.0-0.dll libintl-8.dll libpng16-16.dll libjpeg-8.dll libtiff-*.dll libopenjp2-*.dll liblcms2-2.dll libcrypto-3*.dll libssl-3*.dll libzstd.dll zlib1.dll libbz2-1.dll liblzma-5.dll libpoppler-qt6-*.dll SDL2.dll libharfbuzz-0.dll libgraphite2.dll libbrotlidec.dll libbrotlicommon.dll libpcre2-16-0.dll; do
            cp "/${{ matrix.msystem }}/bin/$dll" . 2>/dev/null || true
          done
          
          # Copy share folder
<<<<<<< HEAD
          $shareSource = "D:\a\_temp\msys64\$msysDir\share\poppler"
          if (Test-Path $shareSource) {
            New-Item -ItemType Directory -Path "share" -Force | Out-Null
            Copy-Item -Path $shareSource -Destination "share" -Recurse -Force
            Write-Host "Copied Poppler data files" -ForegroundColor Green
          }
          Write-Host "::endgroup::"
=======
          mkdir -p share
          cp -r "/${{ matrix.msystem }}/share/poppler" ./share/ 2>/dev/null || true
          echo "::endgroup::"
>>>>>>> parent of d0e675d (Merge pull request #100 from alpha-liu-01/test)
          
          echo "Build completed successfully!"
          ls -lh NoteApp.exe
          
          cd ..

      - name: Upload EXE
        uses: actions/upload-artifact@v4
        with:
          name: speedynote-windows-package-${{ matrix.arch }}
          path: "build/*.exe"

  # build-dmg:
  #   name: Build macOS DMG
  #   runs-on: macos-latest
  #   strategy:
  #     matrix:
  #       arch: [x86_64, arm64]
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Homebrew
  #       run: |
  #         brew install qt@6
  #         brew install poppler
  #         brew install sdl2

  #     - name: Build
  #       shell: bash
  #       run: |
  #         ./build_poppler_qt6.sh
  #         ./compile-mac.sh

  #     - name: Upload DMG
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: speedynote-macos-package-${{ matrix.arch }}
  #         path: "*.dmg"

  release:
    name: Create Release
    needs: [build-deb, build-rpm, build-exe]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download DEB packages
        uses: actions/download-artifact@v4
        with:
          pattern: speedynote-deb-package-*
          path: .

      - name: Download RPM packages
        uses: actions/download-artifact@v4
        with:
          pattern: speedynote-rpm-package-*
          path: .

      - name: Download EXE packages
        uses: actions/download-artifact@v4
        with:
          pattern: speedynote-windows-package-*
          path: .

      - name: Upload packages to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            **/*.deb
            **/*.rpm
            **/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}