name: Test Docker Compose

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-docker-compose:
    name: Test Docker Compose Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          tags: speedynote-builder:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker Compose Build
        run: |
          # 测试docker-compose build
          docker-compose build
          echo "✅ Docker Compose build successful"

      - name: Test Docker Compose Up
        run: |
          # 测试docker-compose up -d
          docker compose up -d
          echo "✅ Docker Compose up successful"
          
          # 等待容器启动
          sleep 30
          
          # 检查容器状态
          docker compose ps
          
          # 检查容器是否正常运行
          if docker compose ps | grep -q "Up"; then
            echo "✅ All containers are running"
          else
            echo "❌ Some containers are not running"
            docker compose logs
            exit 1
          fi

      - name: Test Docker Compose Down
        run: |
          # 测试docker-compose down
          docker compose down
          echo "✅ Docker Compose down successful"
          
          # 验证容器已停止
          if docker compose ps | grep -q "Up"; then
            echo "❌ Some containers are still running"
            exit 1
          else
            echo "✅ All containers are stopped"
          fi

      - name: Cleanup
        if: always()
        run: |
          # 确保清理所有容器和镜像
          docker compose down -v --remove-orphans
          docker system prune -f

  test-multi-arch:
    name: Test Multi-Architecture Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build multi-architecture image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: ${{ matrix.platform }}
          tags: speedynote-builder:multi-arch-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image
        run: |
          # 测试镜像是否可以运行基本命令
          docker run --rm speedynote-builder:multi-arch-test bash -c "
            echo 'Testing basic functionality on ${{ matrix.platform }}'
            uname -m
            cmake --version
            make --version
            echo '✅ Basic functionality test passed'
          "

  validate-compose-file:
    name: Validate Docker Compose File
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          # 验证docker-compose.yml语法
          if docker compose config -q; then
            echo "✅ docker-compose.yml is valid"
          else
            echo "❌ docker-compose.yml has syntax errors"
            exit 1
          fi
          
          # 显示配置信息
          docker compose config

      - name: Validate Dockerfile
        run: |
          # 验证Dockerfile语法
          if docker build -q . > /dev/null 2>&1; then
            echo "✅ Dockerfile is valid"
          else
            echo "❌ Dockerfile has syntax errors"
            exit 1
          fi